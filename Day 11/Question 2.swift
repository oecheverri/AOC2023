import Foundation

let sampleData = """
...#......
.......#..
#.........
..........
......#...
.#........
.........#
..........
.......#..
#...#.....
"""

let puzzleInput = """
........#.........................................................................................................#..................#......
.............#.......................#....................................#......#......................#.......................#...........
...............................#...........#...........................................................................#....................
.........................#...........................#.......................................#...........................................#..
.....#...............................................................................#......................................................
....................................................................................................................................#.......
...........................................................#..............................#................#.......#........................
..........#..........#............#..................................#......#...............................................................
.........................................#..................................................................................................
#..............#.............#.......................#........................................#.......................#.....................
......#..........................................................................#......#...........#.......................................
................................................................................................................#...........................
............#...........#...............................#..............#...................................#................................
....................................#................................................#.....................................#................
...#.............#..............................................#...........................................................................
.......................................................................................................#....................................
.........#.....................#...............................................................#............................................
.........................................................................................................................................#..
#...............................................................................#.....................................#.....................
......#...........#.................#..........#.........................................#..................................................
...........#............#..............................#..............#..........................................#..........................
...................................................................................#..............#...........................#.............
..................................................#.........................................................................................
.............................................#............................................................................#.............#...
.........................................................................................................#..................................
.....#........................#...........................#.....#..............#............#...............................................
................#................................................................................................................#..........
................................................#.............................................................#.............................
..........................#..........#.......................#.....................#.....#...........#......................................
............#......#........................#.....................#.....#.....................#........................#...................#
............................................................................................................................................
................................#.......................#...................................................................#...............
.....#...................................#...................................................................#........................#.....
....................................#.......................#...............................................................................
.............................................#................................#................#................................#...........
#.....................#.................................................#............................#......................................
.....................................................#............................................................#.......#.........#.......
..................#............................................#...........................................................................#
...............................#.......#..................................................................#.................................
............#..............................................................#.................................................#..............
...................................#........................................................#...............................................
#....................#......................................................................................................................
......#....................................................#.......................................#........................................
...................................................................#...........#...............................................#.....#......
.............................#..................#................................................................#..........................
...................#...............................................................#......................................#.................
............................................................................................................................................
............................................#....................#.................................................................#........
........#......#...............#.......#...........#.........................................#..............................................
........................................................................................#.........#........#................................
............................................................................................................................................
..#..............................................................................#..........................................................
..................................#.......................#.............................................#........#.....................#....
.............#...............#..............#.....................................................................................#.........
............................................................................................................................................
.....................................#.............................#....................#...................................................
..........#.................................................................................................................................
.....#...........................#.......#...............................#..........#........#...............#.....#......#.................
................................................#..................................................#........................................
#.......................................................................................................................................#...
............................................................................................................................................
.....................#................................#........................................#...........#................................
...........#..............#..........................................#......................................................................
....................................#...........................#...............#....................#................#............#......#.
......#..............................................................................#......................................#...............
..............#.................#..............#..........................................#.................................................
...........................................................#.............#..................................................................
.#......................................................................................................................................#...
...............................................................................#.........................#.....#..................#.........
.................................................................#...............................#...................#......................
.......#.........#.....#..................#..........#...............................#......................................................
...........................................................................................................................#................
.............................#........#......................#..............................................#............................#..
........................................................#..........................................#...............#........................
...............................................................................#...................................................#........
............#...................#.......................................................................#...................................
......#....................#................#.........................#.................#.....#.............................................
...................................................#........................................................................................
.....................#...............#.....................................#.............................................#.................#
.........#.........................................................#.................................#......................................
............................................................................................................................................
............................................................................................................................................
.....#...........................................#..........#.....................................#.......#.................................
........................#......#............................................................................................................
..............................................................................#..............#........#.....................................
#.................#.........................#......................................................................#........................
.............#.........................#..................#........................#......................................#.................
........................................................................#...................................................................
....#...................................................................................................#.................................#.
.....................#.............................................#............#.......#.......................................#...........
...............................................#............#..................................#............................................
..............#................#...........................................#............................................#...................
.#.....#....................................................................................................................................
...........................#........#..................#.........#..................................................................#.......
...............................................................................................................................#............
....................#......................#.......................................#...........................#............................
..........#........................................#..........#...............#...................#.........................................
..................................#......................................................................#.................#................
.......................#......................................................................#......................#......................
..................#............................#.................#......#...................................................................
.................................................................................#.............................................#............
............#.................#......#..............................................................................................#.....#.
#.....................................................#....................#.........#..........................#...........................
.....#.....................................#................#...............................................................................
..................................#.........................................................................................#..........#....
................#.......................................................................#......#............................................
........................................#...................................................................................................
.........#.............#.......................#.......................................................#............................#.......
..............................................................................#.............................................................
#.............................#....................................................#........................................................
......................................#.....................#.....................................................#..............#..........
..................................................................#.......................#................#...............................#
...................#..............#...................#..............................................#..................#...................
................................................................................................#...........................................
.......#.....#..............................................................................................................................
..................................................#.................................................................................#.......
......................#..................#........................................#....................#......#...........................#.
.......................................................#.................#................#................................#................
...........................#.......................................#................................................#.......................
.................................................................................................................................#..........
......#..........................................#.............................#......................................................#.....
...................#....................#............................................#..........#...........................................
...........#.........................................#...........#..........................................#...............................
..#..............................#.........................................#...........................................#....................
......................................................................#.................#...................................................
.......................#...................................................................................................#................
...........................................................#......................#..................#........#.............................
.....#................................#.....#.......................................................................#..............#........
#...............................#........................................#.......................#..........................................
........................................................................................................................#...................
.........................................#..................................................................................................
............#.....................................#..................#......#................#........................................#.....
........................................................#......#.......................................#....................................
........#.........#..................#..................................................#.......................#...........................
................................................................................#........................................#.........#........
............................................................................................................#.................#.............
........................................#......#............................................................................................
....................#..............................................................#............#......................................#....
.........#.....................#.........................................#.............................#.......#............................
...#......................#............................#........#......................#...............................#..........#.........
"""

class Coordinates: Equatable {
    
    var x: Int
    var y: Int
    
    init(x: Int, y: Int) {
        self.x = x
        self.y = y
    }
    
    static func == (lhs: Coordinates, rhs: Coordinates) -> Bool {
        lhs.x == rhs.x && lhs.y == rhs.y
    }
}

enum SpaceObjectType: String, Equatable, CustomStringConvertible {
    case galaxy = "#"
    case vacuum = "."
    
    init?(from value: Character) {
        self.init(rawValue: String(value))
    }
    
    var description: String {
        switch self {
            case .galaxy:
                return "ðŸª"
            case .vacuum:
             return "â—¼ï¸"
        }
    }
}

class SpaceObject: Equatable, CustomStringConvertible {
    
    var coordinates: Coordinates
    let type: SpaceObjectType
    
    convenience init?(from value: Character, x: Int, y: Int) {
        self.init(from: value, at: .init(x: x, y: y))
    }
    
    convenience init?(from value: Character, at coordinates: Coordinates) {
        guard let type = SpaceObjectType(from: value) else { return nil }
        self.init(type, at: coordinates)
    }
    
    init(_ type: SpaceObjectType, at coordinates: Coordinates) {
        self.type = type
        self.coordinates = coordinates
    }
    
    var isGalaxy: Bool {
        type == .galaxy
    }
    
    var description: String {
        "(\(String(format: "%02d",coordinates.x)):\(String(format: "%02d",coordinates.y)))"
    }
    
    func stepsBetween(_ object: SpaceObject) -> Int {
        abs(coordinates.x - object.coordinates.x) + abs(coordinates.y - object.coordinates.y)
    }
    
    static func == (lhs: SpaceObject, rhs: SpaceObject) -> Bool {
        lhs.coordinates == rhs.coordinates && lhs.type == rhs.type
    }
}

typealias ExpansionFactors = [[(x: Int, y: Int)]]

extension ExpansionFactors {
    func getColumn(index: Int) -> [(x: Int, y: Int)] {
        var factors = [(x: Int, y: Int)]()
        forEach {
            factors.append($0[index])
        }
        return factors
    }
    
}

func totalOffset(at index: Int, for gradient: [Int]) -> Int {
    gradient[0..<index].reduce(0) { $0 + $1 }
}

struct Universe: CustomStringConvertible {
    
    var spaceTime: [[SpaceObject]]
    
    init(spaceTime: [[SpaceObject]]) {
        self.spaceTime = spaceTime
    }
    
    enum Axis {
        case x, y
    }
    static let expansionQuantity = 1000000
    
    var galaxies: [SpaceObject] {
        spaceTime.flatMap{ $0.filter(\.isGalaxy) }
    }
    
    var description: String {
        var description = ""
        for row in spaceTime {
            description.append(row.description)
            description.append("\n")
        }
        return description
    }
    
    func getColumn(at index: Int) -> [SpaceObject] {
        spaceTime.flatMap{ $0.filter{ $0.coordinates.x == index } }
    }
    
    func getRow(at index: Int) -> [SpaceObject] {
        spaceTime[index]
    }
    
    mutating func expand() {
        let yOffsets = calculateOffsets(for: .y)
        let xOffsets = calculateOffsets(for: .x)
        
        for (index, yOffset) in yOffsets.enumerated() {
            for columnIndex in spaceTime[index].indices {
                spaceTime[index][columnIndex].coordinates.y = yOffset
            }
        }
        
        for (column, xOffset) in xOffsets.enumerated() {
            for rowIndex in spaceTime.indices {
                spaceTime[rowIndex][column].coordinates.x = xOffset
            }
        }
    }
    
    func calculateOffsets(for axis: Axis) -> [Int] {
        var offsets = [Int]()
        
        for index in 0..<(axis == .y ? spaceTime.endIndex : spaceTime[0].endIndex) {
            let previousValue = index == 0 ? -1 : offsets[index - 1]
            offsets.append(previousValue + (hasGalaxy(objects: axis == .y ? getRow(at: index) : getColumn(at: index)) ? 1 : Universe.expansionQuantity))
        }
        return offsets
    }
}

let input = puzzleInput

var universe: Universe = .init(spaceTime: input.components(separatedBy: "\n")
    .enumerated().map {y, rowString in
        rowString.enumerated()
        .compactMap {x, value in
            SpaceObject.init(from: value, x: x, y: y)
        }
    })

func hasGalaxy(objects: [SpaceObject]) -> Bool {
    for object in objects {
        if object.isGalaxy {
            return true
        }
    }
    return false
}

universe.expand()

let sum = universe.galaxies.map { galaxy in
    universe.galaxies.reduce(0) {
        $0 + galaxy.stepsBetween($1)
    }
}.reduce(0) {$0 + $1} / 2

print(sum)
